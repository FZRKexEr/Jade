# UCI 引擎配置指南

本文档详细介绍如何配置和使用 UCI 协议的中国象棋引擎。

## 目录

- [支持的引擎](#支持的引擎)
- [引擎下载和安装](#引擎下载和安装)
- [UCI 选项说明](#uci-选项说明)
- [多引擎配置](#多引擎配置)
- [引擎故障排查](#引擎故障排查)

## 支持的引擎

本应用支持所有符合 UCI (Universal Chess Interface) 协议的中国象棋引擎。

### 推荐引擎

| 引擎 | 描述 | 平台 | 推荐程度 |
|------|------|------|----------|
| [Pikafish](https://github.com/official-pikafish/Pikafish) | 最强的开源中国象棋引擎，基于 Stockfish 开发 | macOS/Linux/Windows | ⭐⭐⭐⭐⭐ |
| [Fairy-Stockfish](https://github.com/fairy-stockfish/Fairy-Stockfish) | 支持多种象棋变体的引擎，包括中国象棋 | macOS/Linux/Windows | ⭐⭐⭐⭐ |

### Pikafish 简介

Pikafish 是目前最强的开源中国象棋引擎，特点：

- **基于 Stockfish**: 继承了 Stockfish 强大的搜索算法
- **NNUE 评估**: 使用神经网络评估局面
- **高性能**: 充分利用现代 CPU 的多线程能力
- **开源免费**: 遵循 GPL 协议，完全免费使用

### Fairy-Stockfish 简介

Fairy-Stockfish 是一个支持多种象棋变体的引擎：

- **多变体支持**: 中国象棋、日本将棋、国际象棋等
- **灵活配置**: 可以通过 UCI 选项切换不同变体
- **统一接口**: 所有变体使用相同的 UCI 协议

## 引擎下载和安装

### 自动下载 Pikafish（推荐）

应用内置了 Pikafish 的自动下载功能：

1. 打开应用，进入 **引擎** > **引擎管理**

<!-- TODO: Screenshot - 引擎管理界面截图 -->

2. 点击"下载 Pikafish"按钮

3. 选择适合你的 Mac 的版本：

   | 版本 | 适用机型 |
   |------|----------|
   | Apple Silicon (ARM64) | M1, M2, M3 系列 Mac |
   | Intel (x86_64) | Intel 芯片 Mac |

4. 等待下载和自动配置完成

5. 配置完成后，点击"连接引擎"开始使用

### 手动下载 Pikafish

如果需要手动下载和配置：

#### 1. 下载引擎

1. 访问 [Pikafish Releases](https://github.com/official-pikafish/Pikafish/releases)
2. 下载最新版本的 macOS 二进制文件
3. 文件名格式：`pikafish-macos-xx.tar`

#### 2. 解压文件

```bash
# 使用命令行解压
tar -xvf pikafish-macos-xx.tar

# 或双击解压
```

#### 3. 添加执行权限

```bash
chmod +x /path/to/pikafish
```

#### 4. 在应用中配置

1. 打开应用，进入 **引擎** > **引擎管理**
2. 点击"添加引擎"按钮
3. 选择解压后的 `pikafish` 可执行文件
4. 输入引擎名称（如"Pikafish"）
5. 点击"添加"

### 下载 Fairy-Stockfish

1. 访问 [Fairy-Stockfish Releases](https://github.com/fairy-stockfish/Fairy-Stockfish/releases)
2. 下载 macOS 版本
3. 解压并添加执行权限
4. 在应用中添加引擎

**注意**: Fairy-Stockfish 需要设置 UCI_Variant 选项为 `xiangqi` 才能正确下中国象棋。

## UCI 选项说明

UCI 引擎支持多种配置选项，通过修改这些选项可以调整引擎的行为和强度。

### 常用 UCI 选项

#### Hash（哈希表大小）

**说明**: 引擎用于存储局面评估的内存大小

**取值范围**: 1 - 65536 MB

**建议值**:
| 内存大小 | 建议 Hash 值 |
|----------|-------------|
| 4GB | 256-512 MB |
| 8GB | 512-1024 MB |
| 16GB+ | 1024-4096 MB |

**影响**: 更大的 Hash 可以提高搜索效率，但超过一定大小后收益递减

#### Threads（线程数）

**说明**: 引擎使用的 CPU 线程数

**取值范围**: 1 - 512

**建议值**:
| CPU 核心数 | 建议 Threads |
|-----------|-------------|
| 4 核 | 2-3 |
| 6 核 | 3-4 |
| 8 核 | 4-6 |
| 12+ 核 | 6-8 |

**注意**:
- 建议设置为物理核心数的一半到全部，而非超线程数
- 过高的线程数可能导致性能下降

#### Skill Level（技能等级）

**说明**: 控制引擎的强度和思考深度

**取值范围**: 0 - 20

**等级参考**:
| 等级 | 描述 | 适合对手 |
|------|------|----------|
| 0 | 最弱，随机走子 | 完全初学者 |
| 5 | 弱，明显的战术错误 | 初学者 |
| 10 | 中等，偶尔失误 | 业余爱好者 |
| 15 | 强，极少失误 | 高手 |
| 20 | 最强，全力发挥 | 专业棋手 |

#### UCI_Variant（变体类型）

**说明**: 指定玩的象棋变体

**取值**:
- `xiangqi` - 中国象棋（默认）
- `chess` - 国际象棋
- `shogi` - 日本将棋
- 其他变体...

**注意**: Fairy-Stockfish 需要设置此选项才能正确下中国象棋。

### 高级 UCI 选项

#### UCI_AnalyseMode（分析模式）

启用分析模式的特殊行为，如显示更多变线。

#### UCI_ShowWDL（显示胜率）

显示当前局面的胜率评估（胜/和/负）。

#### UCI_Elo（等级分）

设置引擎以特定的 Elo 等级分进行对弈。

#### MultiPV（多主变线）

显示多个候选着法及其评估：
- 取值范围: 1 - 500
- 设置为 1 只显示最佳着法
- 设置为更大的值显示多个选择

#### Contempt（自负值）

控制引擎的求胜欲望：
- 正值: 更积极求胜
- 负值: 更倾向和棋

### 在应用中配置 UCI 选项

1. 点击菜单 **引擎 > 引擎选项**

<!-- TODO: Screenshot - 引擎选项对话框截图 -->

2. 在对话框中修改各项参数
3. 点击"应用"保存设置
4. 部分设置需要重新连接引擎才能生效

## 多引擎配置

### 添加多个引擎

应用支持配置多个引擎，方便在不同场景下切换使用：

1. 进入 **引擎 > 引擎管理**
2. 点击"添加引擎"按钮
3. 选择引擎可执行文件
4. 输入引擎名称（如"Pikafish-Strong"）
5. 点击"添加"

### 配置不同难度级别

为同一个引擎配置不同强度：

#### 配置"弱"引擎

1. 添加引擎，命名为"Pikafish-Weak"
2. 设置 UCI 选项:
   - `Skill Level` = 5
   - `Hash` = 64
   - `Threads` = 1

#### 配置"强"引擎

1. 添加引擎，命名为"Pikafish-Strong"
2. 设置 UCI 选项:
   - `Skill Level` = 20
   - `Hash` = 1024
   - `Threads` = 4

### 切换引擎

1. 进入 **引擎 > 引擎管理**
2. 在引擎列表中选择要使用的引擎
3. 点击"连接"按钮
4. 当前连接的引擎会显示为"已连接"状态

### 引擎配置文件

引擎配置保存在应用的配置文件：

```
~/Library/Application Support/ChineseChess/engines.json
```

可以手动编辑此文件进行批量配置：

```json
{
  "engines": [
    {
      "name": "Pikafish-Strong",
      "path": "/path/to/pikafish",
      "options": {
        "Hash": 1024,
        "Threads": 4,
        "Skill Level": 20
      }
    },
    {
      "name": "Pikafish-Weak",
      "path": "/path/to/pikafish",
      "options": {
        "Hash": 64,
        "Threads": 1,
        "Skill Level": 5
      }
    }
  ]
}
```

## 引擎故障排查

### 常见问题

#### 引擎无法启动

**症状**: 点击"连接引擎"后提示连接失败

**排查步骤**:

1. **检查文件权限**
   ```bash
   ls -l /path/to/engine
   # 确保有执行权限
   chmod +x /path/to/engine
   ```

2. **测试引擎是否可执行**
   ```bash
   /path/to/engine
   # 应该显示 UCI 信息
   ```

3. **检查架构兼容性**
   ```bash
   file /path/to/engine
   # 确保与系统架构匹配（ARM64 或 x86_64）
   ```

#### 引擎连接后无响应

**症状**: 引擎已连接，但发送指令无反应

**解决方案**:

1. **重新连接引擎**: 断开后再重新连接
2. **重启应用**: 完全关闭应用后重新打开
3. **检查引擎配置**: 确认 UCI_Variant 设置为 `xiangqi`
4. **查看日志**: 帮助 > 查看日志，检查错误信息

#### 引擎分析结果不准确

**症状**: 引擎建议的着法明显有问题

**可能原因**:

1. **Skill Level 设置太低**: 提高 Skill Level 到 15-20
2. **Hash 太小**: 增加 Hash 大小到 512MB 或更大
3. **分析时间太短**: 增加思考时间或深度
4. **引擎版本问题**: 更新到最新版本

#### 引擎占用过多资源

**症状**: 电脑发热严重，风扇狂转，其他应用卡顿

**解决方案**:

1. **降低 Threads**: 设置为 CPU 核心数的一半
2. **降低 Hash**: 减小哈希表大小
3. **限制分析时间**: 设置最大分析时间
4. **关闭多引擎分析**: 只使用单个引擎

### 引擎日志

启用引擎日志记录以便排查问题：

1. 进入 **帮助 > 查看日志**
2. 勾选"启用引擎通信日志"
3. 重新连接引擎
4. 重现问题
5. 查看日志文件了解通信详情

日志文件位置：
```
~/Library/Logs/ChineseChess/engine.log
```

### 获取帮助

如果以上方法无法解决问题，可以：

1. **查看日志**: 收集引擎日志和应用日志
2. **提交 Issue**: 在 GitHub Issues 报告问题，附上日志
3. **引擎社区**: 访问 Pikafish 或 Fairy-Stockfish 的 GitHub 页面寻求帮助

---

*继续阅读 [常见问题](FAQ.md) 了解更多问题和解决方案。*
